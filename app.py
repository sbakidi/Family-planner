# ... (The fully merged content of app.py, which is very long) ...